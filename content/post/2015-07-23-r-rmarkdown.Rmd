---
title: "Consistent Marriage License Trends Disrupted By COVID Outbreak"
author: "Xinyi Zhang"
date: 2020-09-27T11:58:59-05:00
bibliography: "references.bib"
categories: ["R"]
tags: ["R Markdown", "plot", "regression"]
---
Authored by Xinyi Zhang

```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE)
```

# Abstract
From a cultural, social, and even legal viewpoint, getting married is widely considered one of the most significant events in a person's life. In this analysis, we identify the seasonal and annual trends in the number of marriage licenses that are issued by the City Clerk's Office of Toronto as published in the "Marriage Licence Statistics" dataset on Toronto's Open Data Portal. Most notably, thanks to public health policies and public adherence to those policies, the number of marriage licenses issued in the past few months are significantly lower than usual. Our findings from exploring this dataset have provided a basic method for evaluating the effectiveness of social distancing policies and big picture-wise have pinpointed cyclical trends in the issuance of marriage licenses that may be of interest to sociologists and curious couples.


# Introduction
First paragraph: General. Motivational. Majors specific finding. 

Second paragraph: More about what you did and found.

Third paragraph: Outline of the paper. Future work. Weaknesses.


# Data Description {#description}
The "Marriage Licence Statistics" dataset contains 453 observations that document the number of marriage licenses issued per civic center per month in the city of Toronto. Starting in January of 2011, the dataset spans a period of almost ten years and was last updated on September 1st of this year with data for the month of August. The dataset has only four features: 

* _id: an unique observation identifier
* CIVIC_CENTRE: a two letter code for one of four civic centers in Toronto ("TO" being Toronto City Hall, "NY" being North York Civic Center, "ET" being Etobicoke Civic Center, and "SC" being Scarborough Civic Center)
* MARRIAGE_LICENSES: a count of how many marriage licenses were issued in the given month
* TIME_PERIOD: the year and month the observation was made

In Figure \@ref(fig:overall), I plotted the full dataset to get a sense of what we are working with. (The code used to generate this and subsequent figures can be found in the [Appendix](#appendix).) I included information about the locations where licenses were issued by using different colors for each civic center (namely red for "ET", green for "NY", blue for "SC", and purple for "TO").


```{r overall, fig.width=8, fig.height=4, fig.cap='A plot of the number of marriage licenses issued per month per civic center over the past ten years.', echo=FALSE, message=FALSE}
library(tidyverse)
library(opendatatoronto)

marriage_license_packages <- opendatatoronto::search_packages("Marriage Licence Statistics")

marriage_license_resources <- marriage_license_packages %>% 
  opendatatoronto::list_package_resources()

marriage_license_statistics <- marriage_license_resources %>%
  opendatatoronto::get_resource()

agg_marriage_license = aggregate(x=marriage_license_statistics$MARRIAGE_LICENSES, 
                                 by=list(marriage_license_statistics$TIME_PERIOD), 
                                 FUN=sum)

agg_marriage_license = rename(agg_marriage_license, TIME_PERIOD=Group.1, TOTAL_MARRIAGE_LICENSES=x)

ggplot(data=marriage_license_statistics, mapping = aes(x=TIME_PERIOD, y=MARRIAGE_LICENSES, color=CIVIC_CENTRE)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1)) +
  xlab("Time Period") +
  ylab("Marriage License Counts") + 
  labs(color="Civic Center") +
  scale_x_discrete(limits=agg_marriage_license$TIME_PERIOD, breaks=agg_marriage_license$TIME_PERIOD[seq(1, length(agg_marriage_license$TIME_PERIOD), by=4)])
```

# Data Discussion {#discussion}

Although Figure \@ref(fig:overall) is just an initial foray into the dataset, several patterns immediately stand out. Perhaps most obvious is the cyclical nature of the counts of marriage licenses with the number for each civic center peaking in the summer months and bottoming out in the winter months. The result of this consistent seasonal behavior is what looks like waves of counts, reaching their peak every July or August and reaching their trough every November through February. Another interesting feature of the plot is that each civic center follows this pattern closely. Although Toronto City Hall appears to be the most popular issuer of marriage licenses with counts often double those of the other civic centers, all four centers exhibit the described wave-like pattern. 

Lastly, there are clearly disruptions to the established patterns in the past few months with many fewer licenses being issued than expected. In Figure \@ref(fig:recent), I've graphed only recent data starting from 2018 to provide a closer look at these anomalies while having access to two years of data to serve as a frame of reference for typical marriage license counts. 

```{r recent, fig.width=8, fig.height=4, fig.cap='A plot of the number of marriage licenses issued per month per civic center since 2018.', echo=FALSE}
select_recent <- filter(marriage_license_statistics, TIME_PERIOD > "2017-12")

ggplot(data=select_recent) +
  geom_point(mapping = aes(x=TIME_PERIOD, y=MARRIAGE_LICENSES, color=CIVIC_CENTRE)) +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1)) + 
  xlab("Time Period") +
  ylab("Marriage License Counts") + 
  labs(color="Civic Center")
```

In what usually would have been rising counts of marriage licenses issued, instead counts fell in March 2020 and continued falling in April 2020, where an all-time low (for this dataset) was hit: only 47 marriage licenses were issued that month. In subsequent months, the number of licenses rose each month (the rate at which will be discussed below). From the lack of data from some of the civic centers over the past few months, presumably they were closed and thus issued zero marriage licenses. This also disrupted previously observed civic center trends with counts of licenses issued by North York Civic Center and Etobicoke Civic Center higher than they have ever previously been recorded in the dataset because they were the only two locations open. 

# Location Aggregated Analysis
In Figure \@ref(fig:agg), I plotted the aggregated counts of marriage licenses issued, i.e., the total number of licenses issued in the city of Toronto per month, losing fine-grained location information. In addition to simplifying the features of the plot, this draws attention to the sharp drop in marriage licenses issued in the past few months compared to the previous recorded years. This wasn't as apparent in previous Figures \@ref(fig:overall) or \@ref(fig:recent) because of the separation of counts into different locations. This also paints a more accurate picture of the recovery of counts in July and August (where again Figures \@ref(fig:overall) and \@ref(fig:recent) made it difficult to evaluate the scale of the recovery because of the separation of counts).

```{r agg, fig.width=7, fig.height=4, fig.cap='A plot of the number of marriage licenses issued aggregated per month over the past ten years.', echo=FALSE}
agg_marriage_license = aggregate(x=marriage_license_statistics$MARRIAGE_LICENSES, 
                                 by=list(marriage_license_statistics$TIME_PERIOD), 
                                 FUN=sum)

agg_marriage_license = rename(agg_marriage_license, TIME_PERIOD=Group.1, TOTAL_MARRIAGE_LICENSES=x)

ggplot(data=agg_marriage_license, aes(x=TIME_PERIOD, y=TOTAL_MARRIAGE_LICENSES, group = 1)) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, vjust=0.5, hjust=1))+ 
  xlab("Time Period") +
  ylab("Total Marriage License Counts") +
  scale_x_discrete(limits=agg_marriage_license$TIME_PERIOD, breaks=agg_marriage_license$TIME_PERIOD[seq(1, length(agg_marriage_license$TIME_PERIOD), by=4)])
```

In Figure \@ref(fig:year), I calculated the average number of marriage licenses issued monthly in each of the past 10 years. This is an averaged monthly count for each year instead of a total sum of counts because we'd like to compare 2020 to historical data but we're missing values for the last four months of this year (September onward). 

```{r year, fig.width=7, fig.height=4, fig.cap="A plot of the average monthly marriage license counts for each year in the past ten years.", echo=FALSE}
agg_marriage_license$month <- substr(agg_marriage_license$TIME_PERIOD, 6, 7)
agg_marriage_license$year <- substr(agg_marriage_license$TIME_PERIOD, 0, 4)

agg_marriage_license_by_year = aggregate(x=agg_marriage_license$TOTAL_MARRIAGE_LICENSES, 
                                          by=list(agg_marriage_license$year), 
                                          FUN=mean)

agg_marriage_license_by_year = rename(agg_marriage_license_by_year, year=Group.1, AVG_MARRIAGE_LICENSES=x)

ggplot(data=agg_marriage_license_by_year, aes(x=year, y=AVG_MARRIAGE_LICENSES, group = 1)) +
  geom_line() +
  xlab("Year") +
  ylab("Average Monthly Marriage License Counts")
```

To describe the plot, after a small dip in 2013, counts steadily rose annually by 1-4% until 2018 where it plateaued at around 1355. This plateau continued into 2019 after which it subsequently dropped to an average count of 768 monthly counts in 2020. We can only speculate but it's possible the final average for 2020 will be even lower than what we have currently calculated because the usual low counts for winter months will be compounded by social distancing policies and rising COVID-19 cases. 

While marriage rates have been reported to be falling in the past few decades in OECD countries, Figure \@ref(fig:year) tells another story. We need additional data (for example marriage license counts for the past few decades) to determine if the steady increase in marriage licenses obtained from 2013 to 2018 is just an blip in the bigger picture of falling marriage rates. Alternatively, if Toronto is truly bucking the trend, we also need additional data to identify the possible reasons for an increase in marriage license counts (such as population growth data, the rise of wedding posts on social media, changes in the portrayal of marriage in popular media, etc.).

In Figure \@ref(fig:month), I plotted the average number of marriage licenses issued per month, excluding the data for 2020. Furthermore in Table \@ref(tab:tablem), I displayed the averages used to generate Figure \@ref(fig:month). The high average counts for July and August and low average counts for November through February align well with what we have already observed when graphing the full dataset.


```{r month, fig.width=7, fig.height=4, fig.cap='A plot of the historic average number of marriage licenses issued per month.', echo=FALSE}
historic_data <- filter(agg_marriage_license, TIME_PERIOD < "2020-01")
agg_marriage_license_by_month = aggregate(x=historic_data$TOTAL_MARRIAGE_LICENSES, 
                                 by=list(historic_data$month), 
                                 FUN=mean)

agg_marriage_license_by_month = rename(agg_marriage_license_by_month, month=Group.1, AVG_MARRIAGE_LICENSES=x)

ggplot(data=agg_marriage_license_by_month, aes(x=month, y=AVG_MARRIAGE_LICENSES, group = 1)) +
  geom_line()+ 
  xlab("Month") +
  ylab("Average Marriage License Counts per Month") 
```

```{r tablem, echo=FALSE}
agg_marriage_license$month <- substr(agg_marriage_license$TIME_PERIOD, 6, 7)
agg_marriage_license$year <- substr(agg_marriage_license$TIME_PERIOD, 0, 4)

historic_data <- filter(agg_marriage_license, TIME_PERIOD < "2020-01")
agg_marriage_license_by_month = aggregate(x=historic_data$TOTAL_MARRIAGE_LICENSES, 
                                 by=list(historic_data$month), 
                                 FUN=mean)

agg_marriage_license_by_month = rename(agg_marriage_license_by_month, month=Group.1, AVG_MARRIAGE_LICENSES=x)

knitr::kable(agg_marriage_license_by_month,
             digits=2,
             col.names=c("Month", "|| Average Marriage License Counts"),
             booktabs=TRUE,
             caption="Historic marriage license averages.")
```

These calculated historic averages can help us more closely evaluate the relative change in the number of marriage licenses issued this year compared to past years. As mentioned in [Dataset Discussion](#discussion), the deviation from previously observed seasonal trends began during March 2020. While all four locations were still issuing licenses, only 616 licenses were issued in March 2020 compared to an average of 1148 being issued in March over the past nine years (a 43% decrease compared to the historic average). Then for April of this year, only 47 marriage licenses were issued compared to a historic average of 1341 licenses issued in April (a 96% decrease). Following this method of comparison, the subsequent months of May, June, July, and August saw a 93%, 65%, 27%, and a 28% decrease in marriage licenses issued, respectively.

To provide some context, new COVID-19 cases in Ontario peaked at the end of April (634) and steadily decreased into early August (33). The significant decrease in counts of marriage licenses issued in April and May coincided with the peak of new COVID-19 cases in Ontario


# Weaknesses
The data available is fairly straightforward. No strong statistical methods were applied. Further

# Next Steps
This analysis of marriage license counts as a function of time can be further extended into the future as vaccines 

# Appendix {#appendix}
The code used to produce this post can be found at https://github.com/cindyzhang99/sta304_ps1/blob/master/content/post/2015-07-23-r-rmarkdown.Rmd.

```{r}

```


# References
* Wickham et al., (2019). Welcome to the tidyverse. Journal of Open Source Software, 4(43), 1686, https://doi.org/10.21105/joss.01686
  
* Sharla Gelfand (2020). opendatatoronto: Access the City of Toronto Open Data Portal. R package version 0.1.3. https://CRAN.R-project.org/package=opendatatoronto